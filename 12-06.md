---
title: 项目可视化框架
date: 12-06 8.53 
categories: 日志
comments: "true"
tag: superset
---
# superset

docker run -d --name clickhouse-test-server --ulimit nofile=262144:262144 --volume=/root/clickhouse/data:/var/lib/clickhouse yandex/clickhouse-server

官网 ： superset ： https://superset.apache.org/

类似于otb ： 开箱即用

把图弄到一个dashboard中 ，显示出来

底层源码  ： python编译的 ： 建议先安装python 然后再安装它 ，不要把superset和mysql在一起

因为原生的superset，需要一个和mysql冲突的包

但是docker还是可以的

先安装python环境

anconda -》 python

python原生 ： 建议

## docker安装

毫无疑问docker安装是最快速的而且，不用担心依赖等

docker安装的步骤如下  ：

先安装yarn工具集

`yum -y install yum-utils`

然后把docker源添加到镜像里

`yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo`

我这里添加的是阿里的镜像源

然后更新软件包索引

`yum makecache fast`

接下来我们就要开始安装docker了

`yum -y install docker-ce docker-ce-cli containerd.io`

设置一下docker开机自启

`systemctl enable docker`

然后我们启动docker

`systemctl start docker`

我们搜索superset镜像

`docker search superset`

直接拉去自己想要的版本 ，我这里拉去的是0.37.2的

`docker pull amancevice/superset:0.37.2`

接下来我们要创建存储superset配置文件及数据文件的文件夹

`mkdir -p /opt/module/docker/superset/conf `

`mkdir -p /opt/module/docker/superset/data`

接下来我们要创建superset的容器，并把端口映射出来

```
docker run --name superset -u 0 -d -p 8088:8088 -v /opt/module/docker/superset/conf:/etc/superset -v /opt/module/docker/superset/data:/var/lib/superset amancevice/superset:0.37.2
```

然后初始化我们的superset数据库

`docker exec -it superset superset db upgrade`

创建superset的管理员账号

`docker exec -it superset superset fab create-admin`

创建成功之后可以对其进行初始化了

`docker exec -it superset superset init `

最后执行开启服务

`docker exec -it superset superset run --with-threads --reload --debugger`

就可以啦 ，我们可以通过web页面 ip:8088访问 因为我们映射的端口是8088嘛

但是要注意一点，就是我们在我们的superset添加数据库的时候不能用修改了host里的别名进行IP替代

因为我们的superset是安装在我们的docker里的哪里的host并没有进行修改，识别不了别名，我们可以对其进行修改，但是嫌麻烦可以直接弄个ip

接下来我们简单弄个启动脚本

```
#!/bin/bash

function check_log_dir()
{
    SUPERSET_LOG_DIR=/usr/local/src/superset/logs
    if [ ! -d $SUPERSET_LOG_DIR ]
    then
        mkdir -p $SUPERSET_LOG_DIR
    fi
}


function superset_start()
{
    cmd="docker start superset;nohup docker exec -it superset superset run --with-threads --reload --debugger >$SUPERSET_LOG_DIR/superset.log 2>&1 &"
    eval $cmd || echo "superset服务已启动"
}


function superset_stop()
{
   docker stop superset
}


function superset_status()
{
  docker ps
}


case $1 in
"start")
     check_log_dir
     superset_start
    ;;
"stop")
     superset_stop
    ;;
"status")
      superset_status
    ;;
*)
    echo Invalid Args!
    echo 'Usage: '$(basename $0)' start|stop|status'
    ;;
esac
```

## 原生安装

superset的原生安装是有坑的 ，以下操作只能是root用

在安装superset的时候容易出现gcc的问题，解决方法就是一直重新安装那一步

下面我们一起来进行原生安装

首先我们要安装python3的一些依赖 `yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel`

然后我们要进行安装EPEL源并安装superset必备的包

`yum install epel-release #安装epel源`

`yum install mysql-devel #安装MySQL开发包，属于pymysqlclient依赖`

`yum install gcc gcc-c++ libffi-devel python-devel python-pip python-wheel openssl-devel cyrus-sasl-devel openldap-devel`

接下来我们要上传自己的python安装包到linuxx服务器上

 `cd /root/公共`

`tar -xf ./Python-3.6.6.tgz`

然后进入到解压出来的文件夹中进行编译

`./configure`

`make && make install`

安装python3的virtualenv并建⽴superset的env

`pip3 install --upgrade pip -i http://pypi.douban.com/simple --trusted-host pypi.douban.com`

`virtualenv -i http://pypi.douban.com/simple --trusted-host pypi.douban.com`

`pip3 install --upgrade setuptools -i http://pypi.douban.com/simple --trusted-host pypi.douban.com`

建⽴superset的env&激活

`python3 -m venv superset-py3`

`source superset-py3/bin/activate #激活superset的venv`

安装superset需要的安装包

这个包的数量很多建议大家创建一个txt文件然后安装

requirement.txt文件添加

```
alembic==1.3.2            # via flask-migrate
amqp==2.5.2               # via kombu
apispec[yaml]==1.3.3      # via flask-appbuilder
attrs==19.3.0             # via jsonschema
babel==2.8.0              # via flask-babel
backoff==1.10.0           # via apache-superset (setup.py)
billiard==3.6.3.0         # via celery
bleach==3.1.0             # via apache-superset (setup.py)     ---
celery==4.4.1             # via apache-superset (setup.py)
cffi==1.13.2              # via cryptography
click==7.1.1              # via apache-superset (setup.py), flask, flask-appbuilder
colorama==0.4.3           # via apache-superset (setup.py), flask-appbuilder
contextlib2==0.6.0.post1  # via apache-superset (setup.py)
croniter==0.3.31          # via apache-superset (setup.py)
cryptography==2.8         # via apache-superset (setup.py)
decorator==4.4.1          # via retry
defusedxml==0.6.0         # via python3-openid
flask-appbuilder==2.2.4   # via apache-superset (setup.py)
flask-babel==1.0.0        # via flask-appbuilder
flask-caching==1.8.0      # via apache-superset (setup.py)
flask-compress==1.4.0     # via apache-superset (setup.py)
flask-jwt-extended==3.24.1  # via flask-appbuilder
flask-login==0.4.1        # via flask-appbuilder
flask-migrate==2.5.2      # via apache-superset (setup.py)
flask-openid==1.2.5       # via flask-appbuilder
flask-sqlalchemy==2.4.1   # via flask-appbuilder, flask-migrate
flask-talisman==0.7.0     # via apache-superset (setup.py)
flask-wtf==0.14.2         # via apache-superset (setup.py), flask-appbuilder
flask==1.1.1              # via apache-superset (setup.py), flask-appbuilder, flask-babel, flask-caching, flask-compress, flask-jwt-extended, flask-login, flask-migrate, flask-openid, flask-sqlalchemy, flask-wtf
geographiclib==1.50       # via geopy
geopy==1.20.0             # via apache-superset (setup.py)
gunicorn==20.0.4          # via apache-superset (setup.py)
humanize==0.5.1           # via apache-superset (setup.py)
importlib-metadata==1.4.0  # via jsonschema, kombu
isodate==0.6.0            # via apache-superset (setup.py)
itsdangerous==1.1.0       # via flask
jinja2==2.10.3            # via flask, flask-babel
jsonschema==3.2.0         # via flask-appbuilder
kombu==4.6.8              # via celery
mako==1.1.1               # via alembic
markdown==3.1.1           # via apache-superset (setup.py)
markupsafe==1.1.1         # via jinja2, mako
marshmallow-enum==1.5.1   # via flask-appbuilder
marshmallow-sqlalchemy==0.21.0  # via flask-appbuilder
marshmallow==2.19.5       # via flask-appbuilder, marshmallow-enum, marshmallow-sqlalchemy
more-itertools==8.1.0     # via zipp
msgpack==0.6.2            # via apache-superset (setup.py)
numpy==1.18.1             # via pandas, pyarrow
pandas==0.25.3            # via apache-superset (setup.py)
parsedatetime==2.5        # via apache-superset (setup.py)
pathlib2==2.3.5           # via apache-superset (setup.py)
polyline==1.4.0           # via apache-superset (setup.py)
prison==0.1.2             # via flask-appbuilder
py==1.8.1                 # via retry
pyarrow==0.16.0           # via apache-superset (setup.py)
pycparser==2.19           # via cffi
pyjwt==1.7.1              # via flask-appbuilder, flask-jwt-extended
python-dateutil==2.8.1    # via alembic, apache-superset (setup.py), croniter, flask-appbuilder, pandas
python-dotenv==0.10.5     # via apache-superset (setup.py)
python-editor==1.0.4      # via alembic
python-geohash==0.8.5     # via apache-superset (setup.py)
python3-openid==3.1.0     # via flask-openid
pytz==2019.3              # via babel, celery, flask-babel, pandas
pyyaml==5.3               # via apache-superset (setup.py), apispec
retry==0.9.2              # via apache-superset (setup.py)
selenium==3.141.0         # via apache-superset (setup.py)
simplejson==3.17.0        # via apache-superset (setup.py)
six==1.14.0               # via bleach, cryptography, flask-jwt-extended, flask-talisman, isodate, jsonschema, pathlib2, polyline, prison, pyarrow, pyrsistent, python-dateutil, sqlalchemy-utils, wtforms-json
sqlalchemy-utils==0.36.1  # via apache-superset (setup.py), flask-appbuilder
sqlalchemy==1.3.12        # via alembic, apache-superset (setup.py), flask-sqlalchemy, marshmallow-sqlalchemy, sqlalchemy-utils
sqlparse==0.3.0           # via apache-superset (setup.py)
urllib3==1.25.8           # via selenium
vine==1.3.0               # via amqp, celery
webencodings==0.5.1       # via bleach
werkzeug==0.16.0          # via flask, flask-jwt-extended
wtforms-json==0.3.3       # via apache-superset (setup.py)
wtforms==2.2.1            # via flask-wtf, wtforms-json
zipp==2.0.0               # via importlib-metadata

```

然后执行 ：

` pip3 install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirement.txt`

从阿里的镜像源安装这些依赖

接下来是安装Superset

到了这一步，就可能会报错，就是gcc的错误，那是因为安装没有成功，我安装了6次才成功，

执行 ；

`pip3 install apache-superset==0.37.1  -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com`

然后**安装Mysql数据包**

`install sqlalchemy==1.3.24 -i http://pypi.douban.com/simple --trusted-host pypi.douban.com`

`pip3 install mysqlclient -i http://pypi.douban.com/simple --trusted-host pypi.douban.com`

`pip3 install "pymssql<3.0" -i http://pypi.douban.com/simple --trusted-host pypi.douban.com `

接下来我们去我们的mysql里执行

`CREATE DATABASE `superset `/*!40100 DEFAULT CHARACTER SET utf8 */;`

创建其源数据库

**修改superset元数据库**

```
 vim superset-py3/lib/python3.6/site-packages/superset/config.py

修改：
SQLALCHEMY_DATABASE_URI = 'mysql://root:123456@hadoop102/superset?charset=utf8'
```

如果没有这个文件的同学，就是上面安装superset的那一步出问题了，要重新执行

**初始化Supetset数据库（Supetset是一个web应用，自带数据库，需要初始化）**

` superset db upgrade`

**创建管理员用户**

`export FLASK_APP=superset`

`flask fab create-admin`

**说明：** flask是一个python web框架，Superset使用的就是flask

**Superset初始化**

` superset init`

然后我们要修改mysql里的表

`alter table superset.table_columns modify type varchar(255);`

然后就可以启动我们的superset了

` superset run -h 自己的机器名或者ip  -p 启动端口`

然后访问

`http://机器ip或者机器名字:端口/`

老规矩接下来我们创建个启动脚本

```
#!/bin/bash

function check_log_dir()
{
    SUPERSET_LOG_DIR=/usr/local/src/superset/logs
    if [ ! -d $SUPERSET_LOG_DIR ]
    then
        mkdir -p $SUPERSET_LOG_DIR
    fi
}

#检查进程是否运行正常，参数1为进程名，参数2为进程端口
function check_process()
{
    pid=$(ps -ef 2>/dev/null | grep -v grep | grep -i $1 | awk '{print $2}')
    ppid=$(netstat -nltp 2>/dev/null | grep $2 | awk '{print $7}' | cut -d '/' -f 1)
    echo $pid
    [ "$ppid" ] && return 0 || return 1
}

function superset_start()
{
    metapid=$(check_process superset 8889)
    cmd="cd /root/公共/Python-3.6.6;source superset-py3/bin/activate;nohup superset run -h bigdata4 -p 8889 >$SUPERSET_LOG_DIR/superset.log 2>&1 &"
    eval $cmd || echo "superset服务已启动"
}


function superset_stop()
{
    metapid=$(check_process superset 8889)
    [ "$metapid" ] && kill $metapid || echo "superset服务未启动"
}


case $1 in
"start")
     check_log_dir
     superset_start
    ;;
"stop")
     superset_stop
    ;;
"status")
     check_process superset 8889 >/dev/null && echo "superset服务运行正常" || echo "superset服务运行异常"
    ;;
*)
    echo Invalid Args!
    echo 'Usage: '$(basename $0)' start|stop|status'
    ;;
esac


```

关于superset的原生安装就ok了

# dataease

先在官网下载官网地址 ： https://www.fit2cloud.com/dataease/features.html

目前没有时间等周六周日补上

dataease安装特别简单而且图形炫酷，首推

但是有问题：安装dataease的机器上不能有mysql或者你把mysql的端口改掉，因为它要占用3306端口

不管是在线安装还是离线安装对我们的数据库都有要求，mysql 5.7起步

而且要求我们编辑/etc/my.cnf文件

然后添加以下内容

```
[mysqld]
datadir=/var/lib/mysql

default-storage-engine=INNODB
character_set_server=utf8
lower_case_table_names=1
table_open_cache=128
max_connections=2000
max_connect_errors=6000
innodb_file_per_table=1
innodb_buffer_pool_size=1G
max_allowed_packet=64M
transaction_isolation=READ-COMMITTED
innodb_flush_method=O_DIRECT
innodb_lock_wait_timeout=1800
innodb_flush_log_at_trx_commit=0
sync_binlog=0
group_concat_max_len=1024000
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
skip-name-resolve

[mysql]
default-character-set=utf8

[mysql.server]
default-character-set=utf8
```

在线安装 ：`curl -sSL https://github.com/dataease/dataease/releases/latest/download/quick_start.sh | sh`

就可以了

离线安装：

先下载好安装包然后解压，之后到解压的目录，然后编辑install.conf文件下面是install.conf的配置

```
# 基础配置
## 安装目录
DE_BASE=/opt
## Service 端口
DE_PORT=80
## 部署及运行模式，可选值有 local、simple、cluster，分别对应 本地模式、精简模式、集群模式
DE_ENGINE_MODE=simple
## docker 网段设置
DE_DOCKER_SUBNET=172.19.0.0/16
## docker 网关 IP
DE_DOCKER_GATEWAY=172.19.0.1
## Apache Doris FE IP (外部 Doris 此参数无效)
DE_DORIS_FE_IP=172.19.0.198
## Apache Doris BE IP (外部 Doris 此参数无效)
DE_DORIS_BE_IP=172.19.0.199

# 数据库配置
## 是否使用外部数据库
DE_EXTERNAL_MYSQL=false
## 数据库地址
DE_MYSQL_HOST=mysql
## 数据库端口
DE_MYSQL_PORT=3306
## DataEase 数据库库名
DE_MYSQL_DB=dataease
## 数据库用户名
DE_MYSQL_USER=root
## 数据库密码
DE_MYSQL_PASSWORD=Password123@mysql

# Apache Doris 配置
## 是否使用外部 Apache Doris
DE_EXTERNAL_DORIS=false
## Doris 地址
DE_DORIS_HOST=doris-fe
## Doris 查询连接端口
DE_DORIS_PORT=9030
## Doris http端口
DE_DORIS_HTTPPORT=8030
## Doris 数据库名称
DE_DORIS_DB=dataease
## Doris 用户名
DE_DORIS_USER=root
## Doris 密码
DE_DORIS_PASSWORD=Password123@doris

# Kettle 配置
## 是否使用外部 Kettle - (目前还不支持外部Kettle，除非不需运行Kettle，否则请不要修改此参数)
DE_EXTERNAL_KETTLE=false
## Kettle 服务器地址
DE_CARTE_HOST=kettle
## Kettle 访问端口
DE_CARTE_PORT=18080
## Kettle 用户名
DE_CARTE_USER=cluster
## Kettle 密码
DE_CARTE_PASSWORD=cluster
```

安装模式有三种 ：

**DE_ENGINE_MODE=local**
使用本地模式安装，DataEase 会自带 Doris 与 Kettle 组件，无需再做额外配置，但各组件均为单点，不具备高可用特性。
在此模式下，Excel 数据集、API 数据集以及定时同步的数据默认保存在自带的 Doris 组件中。

**DE_ENGINE_MODE=simple**
使用精简模式安装，系统不会额外安装 Doris 与 Kettle 组件，提供用户轻量级的应用系统，尤其是对接数据量较小的情况。
在此模式下，若用户需要使用 Excel 数据集或 API 数据集可在系统管理界面配置数据引擎（目前仅支持 MySQL 类型），相关数据会存储到该数据引擎中。若只需使用数据库直连则无需做此配置。
**注意：由于精简模式未配置 Kettle 与 Doris，故相关 SQL 数据集/数据库数据集不提供定时同步模式。**

**DE_ENGINE_MODE=cluster**
使用集群模式安装，系统不会额外安装 Doris 与 Kettle 组件，但会在系统管理模块提供 Doris 与 Kettle 的链接配置界面（请参考【系统管理】的【系统参数】说明），用户可独立安装 Doris 集群及 Kettle 并配置在 DataEase 中。集群模式下 Excel 数据集，API 数据集以及定时同步的数据通过 Kettle 抽取到 Doris 集群中。
Doris 安装部署可参考：[http://doris.incubator.apache.org/zh-CN/](http://doris.incubator.apache.org/zh-CN/)
Kettle 安装部署可参考：[http://www.kettle.org.cn/](http://www.kettle.org.cn/)

然后对于离线安装执行

```
# 进入安装包目录
cd dataease-v1.5.0-offline
# 运行安装脚本
/bin/bash install.sh
```

就可以了，效果个很酷炫

# 需求

有一个城市表 ： mysql中

有一个商品表 ： mysql中

用户行为数据 ： hdfs上的

求： 最受欢迎的商品 的 top3
